{% extends 'base.html' %}
{% load static %}

{% block navegacion %}
{% include 'navegacion.html' %}
{% endblock %}

{% block contenido %}
<div class="bg-light">
    <div class="container my-5">

        <!-- InformaciÃ³n de la factura -->
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center mb-3 mb-md-0">
                        <img src="{% static 'img/Salud4.png' %}" alt="Logo"
                            style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover;">
                    </div>

                    <div class="col-md-9">
                        <h1 class="text-success fw-bold mb-2">Mundo animal</h1>
                        <hr style="margin-top: 0.2rem; margin-bottom: 1rem; border-color: #ccc;">
                        <p class="mb-1" style="font-size: 1.4rem; font-weight: bold;">
                            <strong>Factura:</strong> <span class="text-dark">{{ numero_factura }}</span>
                        </p>
                        <p class="mb-1"><strong>Fecha:</strong> <span class="text-dark">{{ fecha }}</span></p>
                        <p class="mb-0"><strong>Cliente:</strong> <span class="text-dark">{{ nombre_usuario }} {{ apellido_usuario }}</span></p>
                    </div>
                </div>
            </div>
        </div>

        {% if usuario_no_registrado %}
        <div class="alert alert-warning text-center">
            <strong>Â¡Advertencia!</strong> Debes registrarte para generar una factura.
        </div>
        {% endif %}

        <!-- Tabla del carrito -->
        <div class="table-responsive">
            <table class="table table-striped table-hover text-center">
                <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Acciones</th>
                        <th>Importe</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in carrito.items %}
                    <tr>
                        <td>{{ value.nombre }}</td>
                        <td>{{ value.cantidad }}</td>
                        <td>${{ value.precio }}</td>
                        <td>
                            <a href="{% url 'CarritoApp:sumar_producto' key %}" class="btn btn-success btn-sm me-1">+</a>
                            <a href="{% url 'CarritoApp:Sub' key %}" class="btn btn-danger btn-sm">-</a>
                        </td>
                        <td>${{ value.importe }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Total y botones -->
        <div class="text-end mb-4">
            <h4 class="fw-bold" style="color: #5a1f18; font-weight: 900;">
                Total: ${{ total_carrito }}
            </h4>
        </div>

        <div class="d-flex flex-column flex-md-row justify-content-center gap-2">
            <a href="{% url 'CarritoApp:limpiar_carrito' %}" class="btn btn-danger">
                <i class="bi bi-trash"></i> Limpiar Carrito
            </a>
            <a href="{% url 'CarritoApp:inicio' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver a la Tienda
            </a>
            <button type="button" class="btn btn-success" onclick="verificarCarrito()">
                <i class="bi bi-save"></i> Pagar
            </button>
        </div>
    </div>

<!-- âœ… Modal MÃ©todo de Pago (DINÃMICO + MP) -->
<div class="modal fade" id="metodoPagoModal" tabindex="-1" aria-labelledby="metodoPagoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="metodoPagoModalLabel" style="color:#2e7d32;font-weight:bold;">
          Seleccione Pago
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <form id="formulario_pago" method="POST" action="">
        {% csrf_token %}

        <div class="modal-body">

          <div class="alert alert-success p-2 small" role="alert" style="line-height:1.2;">
            <strong class="text-success">ðŸ”’ PAGO SEGURO</strong><br>
            Rey del Pollo nunca le estÃ¡ solicitando informaciÃ³n de cuentas o pagos por fuera de esta plataforma.
          </div>

          <!-- âœ… OPCIÃ“N EFECTIVO (como en tu cÃ³digo que anda) -->
          <div class="col-12 border p-2 rounded d-flex justify-content-between align-items-center mb-2"
               style="line-height:1.2;font-size:.9rem;">
            <div>
              <input
                type="radio"
                name="metodo_pago"
                value="Efectivo"
                data-nombre="Efectivo"
                class="form-check-input me-2"
                required
              >
              <strong>âœ… Efectivo</strong><br>
              <div class="text-muted">Pago en caja / mostrador</div>
            </div>
            <img src="{% static 'img/efectivo.png' %}"
                 alt="Efectivo"
                 style="width:50px;height:50px;object-fit:contain;"
                 onerror="this.style.display='none'">
          </div>

          <!-- âœ… MÃ‰TODOS DINÃMICOS (alias / cbu / logo) -->
          {% if tipos_pago %}
            <div class="row g-2">
              {% for tipo in tipos_pago %}
                <div class="col-12 border p-2 rounded d-flex justify-content-between align-items-center"
                     style="line-height:1.2;font-size:.9rem;">
                  <div>
                    <input
                      type="radio"
                      name="metodo_pago"
                      value="{{ tipo.id }}"
                      data-nombre="{{ tipo.tipo_pago }}"
                      class="form-check-input me-2"
                      required
                    >
                    <strong>{{ tipo.tipo_pago }}</strong><br>

                    {% if tipo.alias %}
                      <div>Alias: <strong>{{ tipo.alias }}</strong></div>
                    {% endif %}
                    {% if tipo.cbu %}
                      <div>CBU: <strong>{{ tipo.cbu }}</strong></div>
                    {% endif %}
                  </div>

                  {% if tipo.tipo_logo %}
                    <img src="{{ tipo.tipo_logo.url }}"
                         alt="Logo {{ tipo.tipo_pago }}"
                         style="width:50px;height:50px;object-fit:contain;"
                         onerror="this.style.display='none'">
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <hr class="my-3">

          <!-- âœ… BotÃ³n Mercado Pago -->
          <div class="text-center mt-3">
            <a href="{% url 'CarritoApp:mp_checkout' %}">
              <img src="{% static 'img/mercadopago.webp' %}"
                   alt="Pagar con Mercado Pago"
                   style="width:200px;height:auto;cursor:pointer;">
            </a>
          </div>

        </div>

        <div class="modal-footer py-2">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary btn-sm" onclick="procesarPago()">Continuar</button>
        </div>
      </form>

    </div>
  </div>
</div>






    <!-- âœ… Modal Ticket -->
    <div class="modal fade" id="creditoModal" tabindex="-1" aria-labelledby="creditoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content shadow">
                <div class="modal-header bg-light border-bottom">
                    <h5 class="modal-title text-dark" id="creditoModalLabel" style="color: #514c66; font-weight: bold;">
                        Mensaje al Vendedor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="numero_tiket" name="numero_tiket"
                               placeholder="(opcional)">
                    </div>

                    <p class="mt-3 fw-bold text-success">
                        Movimiento en: <span id="tipo_pago_resumen"></span>
                    </p>

                    <button type="button" class="btn btn-primary w-100" onclick="enviarFormularioConTicket()">
                        Finalizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    
<script>
  function verificarCarrito() {
    const total = parseFloat("{{ total_carrito|default:'0'|safe }}");
    const cantidadProductos = parseInt("{{ carrito|length|default:'0'|safe }}");

    if (cantidadProductos === 0 || total === 0) {
      alert("No puedes generar una factura porque el carrito estÃ¡ vacÃ­o.");
      return;
    }

    new bootstrap.Modal(document.getElementById('metodoPagoModal')).show();
  }

  function procesarPago() {
    const metodoSeleccionado = document.querySelector('input[name="metodo_pago"]:checked');

    if (!metodoSeleccionado) {
      alert("Por favor selecciona un mÃ©todo de pago.");
      return;
    }

    const form = document.getElementById("formulario_pago");

    // âœ… nombre para mostrar en el resumen
    const nombreLindo = metodoSeleccionado.dataset.nombre || metodoSeleccionado.value;
    document.getElementById("tipo_pago_resumen").textContent = nombreLindo;

    // âœ… asegurar que el mÃ©todo de pago SIEMPRE se envÃ­a (por las dudas)
    const prevMetodo = form.querySelector('input[name="metodo_pago_hidden"]');
    if (prevMetodo) prevMetodo.remove();

    const metodoHidden = document.createElement("input");
    metodoHidden.type = "hidden";
    metodoHidden.name = "metodo_pago_hidden"; // <- lo lees en backend si querÃ©s
    metodoHidden.value = metodoSeleccionado.value; // puede ser "Efectivo" o "3"
    form.appendChild(metodoHidden);

    // âœ… cerrar modal de mÃ©todo y abrir modal ticket
    const modalMetodoEl = document.getElementById('metodoPagoModal');
    const modalMetodo = bootstrap.Modal.getInstance(modalMetodoEl);
    if (modalMetodo) modalMetodo.hide();

    new bootstrap.Modal(document.getElementById('creditoModal')).show();
  }

  function enviarFormularioConTicket() {
    const ticket = document.getElementById("numero_tiket").value.trim();
    const form = document.getElementById("formulario_pago");

    // âœ… si antes ya se habÃ­a agregado un hidden, lo borramos
    const prevTicket = form.querySelector('input[name="numero_tiket"]');
    if (prevTicket) prevTicket.remove();

    // âœ… SOLO si escribiÃ³ algo, lo mandamos
    if (ticket) {
      const ticketInput = document.createElement("input");
      ticketInput.type = "hidden";
      ticketInput.name = "numero_tiket";
      ticketInput.value = ticket;
      form.appendChild(ticketInput);
    }

    // âœ… Guardar efectivo / invitado (misma lÃ³gica que tu flujo actual)
    const usuario = "{{ request.user.username|escapejs }}";
    const esInvitado = (usuario === "invitado_whatsapp");

    form.action = esInvitado
      ? "{% url 'CarritoApp:imprimir_factura_invitado' %}"
      : "{% url 'CarritoApp:guardar_efectivo' %}";

    form.submit();
  }
</script>




    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
{% endblock %}
