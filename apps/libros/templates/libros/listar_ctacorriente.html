{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block navegacion %}
  {% include 'navegacion.html' %}
{% endblock %}

{% block contenido %}
<header>
  <hr>
  <h1>Cuenta Corriente</h1>
</header>

<main>
  
  {% if user.is_staff %}
<form method="GET"
      action="{% url 'libros:listar_ctacorriente' %}"
      id="form_filtro_cliente"
      style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 10px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">

  <!-- Buscar por cliente (AJAX) -->
  <div style="display:flex; flex-direction:column; position:relative;">
    <label for="cliente_autocomplete" style="font-weight: bold; color: #0b2c4e;">
      Buscar cliente:
    </label>

    <input type="text"
           id="cliente_autocomplete"
           name="cliente_autocomplete"
           value="{{ cliente_label|default:'' }}"
           placeholder="Nombre o apellido..."
           autocomplete="off"
           style="width: 240px; padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">

    <!-- este es el que usa tu vista para filtrar -->
    <input type="hidden"
           id="dni_cliente"
           name="dni_cliente"
           value="{{ request.GET.dni_cliente|default:'' }}">

    <ul id="sugerencias_cliente"
        style="position:absolute; top: 100%; left:0; z-index: 999; width: 240px; display:none; background:white;
               border:1px solid #ccc; border-radius: 8px; list-style:none; margin:4px 0 0; padding:0; max-height: 240px; overflow:auto;">
    </ul>
  </div>

  <!-- Botones -->
  <div style="display:flex; gap:10px;">
    <button type="submit"
            style="background-color: #0b2c4e; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
      Filtrar
    </button>

    <a href="{% url 'libros:listar_ctacorriente' %}"
       style="display:inline-block; background-color:#6c757d; color:#fff; padding:8px 16px; border-radius:6px; text-decoration:none;">
      Limpiar
    </a>
  </div>
</form>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('form_filtro_cliente');
  if (!form) return;

  const input = document.getElementById('cliente_autocomplete');
  const hiddenDni = document.getElementById('dni_cliente');
  const sugerencias = document.getElementById('sugerencias_cliente');

  let debounceTimer = null;
  let controller = null;

  const ocultar = () => (sugerencias.style.display = 'none');
  const mostrar = () => (sugerencias.style.display = 'block');

  input.addEventListener('input', function () {
    const texto = this.value.trim();

    // ✅ si escribe, invalida el DNI anterior
    hiddenDni.value = '';

    if (texto.length < 2) {
      ocultar();
      return;
    }

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      if (controller) controller.abort();
      controller = new AbortController();

      fetch(`/modulo1/api/buscar-clientes/?q=${encodeURIComponent(texto)}`, {
        signal: controller.signal
      })
      .then(r => r.json())
      .then(data => {
        sugerencias.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          ocultar();
          return;
        }

        data.forEach(cliente => {
          const li = document.createElement('li');
          li.textContent = `${cliente.first_name} ${cliente.last_name} (${cliente.dni_usuario})`;
          li.style.padding = '8px 10px';
          li.style.cursor = 'pointer';
          li.style.borderBottom = '1px solid #eee';

          li.addEventListener('mouseenter', () => li.style.background = '#f2f2f2');
          li.addEventListener('mouseleave', () => li.style.background = 'white');

          li.addEventListener('click', () => {
            input.value = `${cliente.first_name} ${cliente.last_name}`;
            hiddenDni.value = cliente.dni_usuario;
            ocultar();
            form.submit(); // ✅ submit GET con dni_cliente
          });

          sugerencias.appendChild(li);
        });

        mostrar();
      })
      .catch(err => {
        if (err.name !== 'AbortError') console.error(err);
        ocultar();
      });
    }, 250);
  });

  // ✅ si aprietan Enter sin elegir sugerencia, no filtra con dni vacío
  form.addEventListener('submit', function (e) {
    const txt = (input.value || '').trim();
    if (txt && !hiddenDni.value) {
      e.preventDefault();
      ocultar();
      alert('Elegí un cliente de la lista para filtrar.');
    }
  });

  document.addEventListener('click', (e) => {
    if (!form.contains(e.target)) ocultar();
  });
});
</script>











  {% if facturas %}
  <table border="1" style="width: 100%; border-collapse: collapse; text-align: left; font-size: 14px;">
    <thead>
      <tr style="background-color: #f2f2f2;">
        <th style="padding: 8px;">Factura Nº</th>
        <th style="padding: 8px;">DNI</th>
        <th style="padding: 8px;">Cliente</th>
        <th style="padding: 8px;">Total</th>
        <th style="padding: 8px;">Fecha</th>
        <th style="padding: 8px;">Pagos</th>
        <th style="padding: 8px;">Debe</th>
        <th style="padding: 8px;">Acciones</th>
      </tr>
    </thead>

    <tbody>
      {% for factura in facturas %}
        {% with metodo1=factura.metodo_pago.tarjeta_nombre|default:"" %}
        {% with metodo2=factura.metodo_pago_manual|default:"" %}
          {% if metodo1|lower == "cuenta corriente" or metodo2|lower == "cuenta corriente" %}
            <tr class="fila-cc"
                data-factura-id="{{ factura.id }}"
                data-numero="{{ factura.numero_factura }}"
                data-debe="{{ deuda_por_factura|get_item:factura.id|default:'0' }}">
              <td style="padding:8px;">{{ factura.numero_factura }}</td>
              <td style="padding:8px;">{% firstof factura.dni_cliente "-" %}</td>
              <td style="padding:8px;">{{ factura.nombre_cliente }} {{ factura.apellido_cliente }}</td>
              <td style="padding:8px;">${{ factura.total_con_interes }}</td>
              <td style="padding:8px;">{{ factura.fecha }}</td>
              <td style="padding:8px;">${{ pagos_por_factura|get_item:factura.id|default:"0.00" }}</td>
              <td style="padding:8px;">
                <span class="debe-original">
                  ${{ deuda_por_factura|get_item:factura.id|floatformat:2|default:"0.00" }}
                </span>
                <small class="queda-por-factura" style="margin-left:6px;color:#6c757d;"></small>
              </td>
              <td style="padding:8px;">
                {% if user.is_staff %}
                  <a href="{% url 'libros:pago_credito' factura.id %}">
                    <button type="button" style="background-color:#11530f;color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
                      Pago Crédito
                    </button>
                  </a>
                {% endif %}

                <a href="{% url 'libros:generar_pdf_credito' factura.id %}">
                  <button type="button" style="background-color:#061322;color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
                    PDF
                  </button>
                </a>
              </td>
            </tr>
          {% endif %}
        {% endwith %}
        {% endwith %}
      {% endfor %}
    </tbody>

    <tfoot>
      <tr>
        <th colspan="3" style="padding: 8px; text-align: right;">Total:</th>
        <th style="padding: 8px;">${{ total_general }}</th>
        <th colspan="4"></th>
      </tr>
      <tr>
        <th colspan="3" style="padding: 8px; text-align: right;">Pagos:</th>
        <th style="padding: 8px;">${{ total_pagos }}</th>
        <th colspan="4"></th>
      </tr>

      <tr>
        <th colspan="3" style="padding: 8px; text-align: right; color: #dc3545;">Debe:</th>
        <th id="td_total_deuda" style="padding: 8px; color:#dc3545;">
          <span id="lbl_total_deuda">${{ total_deuda }}</span>
        </th>
        <th colspan="4"></th>
      </tr>

      {% if user.is_staff %}
      <tr>
        <th colspan="3" style="padding:8px; text-align:right;">
          <span style="color:#dc3545;">Entrega (restar al Debe):</span>
        </th>
        <th style="padding:8px;">
          <input id="inp_entrega_deuda"
                 type="number" min="0" step="0.01"
                 placeholder="Ingrese entrega"
                 style="width:160px; padding:6px 8px; border:1px solid #dc3545; border-radius:6px;">
        </th>
        <th colspan="4" style="padding:8px;">
          <span>Queda:</span>
          <strong id="lbl_queda_deuda">$0.00</strong>
        </th>
      </tr>
      {% endif %}
    </tfoot>
  </table>

  {% else %}
    <p class="no-facturas">No hay facturas registradas con "Cuenta Corriente".</p>
  {% endif %}


  {% if user.is_staff %}
  <div style="margin-top:30px; padding:20px; border:1px solid #ccc; border-radius:8px; background:#f8f9fa;">
    <h3 style="color:#2d8b3d;">Registrar Pago</h3>
    <label for="metodo_pago_entrega"><strong>Pago:</strong></label>
    <select name="metodo_pago" id="metodo_pago_entrega" required>
      <option value="" disabled selected>Seleccione Pago</option>
      <option value="Efectivo">Efectivo</option>
      {% for metodo in metodos_pago %}
        <option value="{{ metodo.id }}">{{ metodo.tarjeta_nombre }}</option>
      {% endfor %}
    </select>
    <input type="hidden" id="entrega_cta_input" name="entrega_cta" value="">
    <button type="button" id="boton_registrar_entrega"
            class="btn btn-success mt-3" style="display:none;">
      Registrar Entrega
    </button>
  </div>
  {% endif %}
</main>

<div class="modal fade" id="entregaModal" tabindex="-1" aria-labelledby="entregaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="entregaModalLabel" style="color:#0b2c4e; font-weight:bold;">Registrar Entrega</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="alert alert-info" id="metodo_pago_seleccionado_entrega">
        Método de pago seleccionado: <strong id="texto_metodo_pago_entrega">-</strong>
      </div>

      <div class="modal-body">
        <input type="hidden" id="suma_entrega" value="">
        ...
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- helpers ----------
  const toNum = (v) => {
    v = (v == null ? '' : String(v));
    v = v.replace(/\$/g,'').replace(/\s+/g,'').replace(',', '.');
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  };
  const fmt = (n) => '$' + (toNum(n)).toFixed(2);

  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  // ---------- DOM ----------
  const lblTotalDebe = document.getElementById('lbl_total_deuda');
  const inpEntrega = document.getElementById('inp_entrega_deuda');
  const lblQuedaTotal = document.getElementById('lbl_queda_deuda');

  const selMetodo = document.getElementById('metodo_pago_entrega');
  const btnEfectivo = document.getElementById('boton_registrar_entrega');
  const inpEntregaHidden = document.getElementById('entrega_cta_input');

  const filas = Array.from(document.querySelectorAll('tbody tr.fila-cc'));

  // Si no está el input de entrega (no staff), igual mostramos por fila “queda”
  const baseDebe = toNum(lblTotalDebe?.textContent || 0);
  if (lblQuedaTotal) lblQuedaTotal.textContent = fmt(baseDebe);

  // ---------- preview / reparto visual ----------
  function repartirPreview(entrega) {
    const usado = Math.min(entrega, baseDebe);
    const quedaRojo = baseDebe - usado;

    if (lblQuedaTotal) lblQuedaTotal.textContent = fmt(quedaRojo);

    let restante = usado;
    // de ABAJO hacia ARRIBA
    filas.slice().reverse().forEach(tr => {
      const debe = toNum(tr.dataset.debe || 0);
      const aplicado = Math.min(restante, debe);
      const quedaFila = debe - aplicado;

      const celda = tr.querySelector('.queda-por-factura');
      if (celda) celda.textContent = '→ queda: ' + fmt(quedaFila);

      restante -= aplicado;
    });

    // si entrega 0, mostrar queda = debe
    if (usado <= 0) {
      filas.forEach(tr => {
        const debe = toNum(tr.dataset.debe || 0);
        const celda = tr.querySelector('.queda-por-factura');
        if (celda) celda.textContent = '→ queda: ' + fmt(debe);
      });
    }
  }

  // init preview
  repartirPreview(0);

  // actualizar preview al escribir entrega (solo si existe input)
  if (inpEntrega) {
    inpEntrega.addEventListener('input', () => {
      const entrega = Math.max(0, toNum(inpEntrega.value || 0));
      repartirPreview(entrega);

      if (inpEntregaHidden) inpEntregaHidden.value = (inpEntrega.value || '');
    });
  }

  // ---------- distribución real (para POST) ----------
  function calcularDistribucion(montoTotal) {
    let restante = montoTotal;
    const distrib = [];

    const filasReverso = filas.slice().reverse();
    for (const tr of filasReverso) {
      if (restante <= 0) break;

      const debe = toNum(tr.dataset.debe || 0);
      if (debe <= 0) continue;

      const facturaId = tr.dataset.facturaId; // ✅ robusto
      if (!facturaId) continue;

      const aplicar = Math.min(restante, debe);
      distrib.push({ facturaId, aplicar });
      restante -= aplicar;
    }
    return distrib;
  }

  // ---------- UI método pago ----------
  if (selMetodo) {
    selMetodo.addEventListener('change', function () {
      const metodoValue = this.value;
      const metodoLabel = this.options[this.selectedIndex]?.text || '-';

      // sincroniza hidden con el input existente
      if (inpEntregaHidden && inpEntrega) inpEntregaHidden.value = inpEntrega.value || '';

      // Efectivo: mostrar botón
      if (metodoValue === 'Efectivo') {
        if (btnEfectivo) btnEfectivo.style.display = 'inline-block';
        return;
      }

      // Tarjeta/otros: ocultar botón y abrir modal si existe bootstrap
      if (btnEfectivo) btnEfectivo.style.display = 'none';

      const modalEl = document.getElementById('entregaModal');
      const sumaEntrega = document.getElementById('suma_entrega');
      const lblMetodo = document.getElementById('texto_metodo_pago_entrega');

      if (lblMetodo) lblMetodo.textContent = metodoLabel;

      const montoActual = Math.max(0, toNum(inpEntrega?.value || 0));
      if (sumaEntrega) sumaEntrega.value = montoActual.toFixed(2);

      if (modalEl && typeof bootstrap !== 'undefined') {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      } else {
        alert('No está cargado Bootstrap (modal). Para tarjeta, pegá el modal completo o usá "Pago Crédito" por factura.');
        this.value = '';
      }
    });
  }

  // ---------- Acción: registrar entrega en efectivo (repartida) ----------
  if (btnEfectivo) {
    btnEfectivo.addEventListener('click', async () => {
      if (!selMetodo || selMetodo.value !== 'Efectivo') {
        alert('Elegí "Efectivo" para registrar entrega.');
        return;
      }

      const total = Math.max(0, toNum(inpEntrega?.value || 0));
      if (!total) {
        alert('Ingresá un monto de entrega válido.');
        return;
      }

      const debeTotal = baseDebe;
      const aUsar = Math.min(total, debeTotal);
      const distribucion = calcularDistribucion(aUsar);

      if (!distribucion.length) {
        alert('No hay deudas para imputar.');
        return;
      }

      const csrftoken = getCookie('csrftoken');

      try {
        for (const item of distribucion) {
          const resp = await fetch(`/libros/factura/${item.facturaId}/pago_credito/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              tipo_pago: 'entrega',
              metodo_pago: 'Efectivo',
              monto_pagado: item.aplicar.toFixed(2),
              entrega_cta: item.aplicar.toFixed(2)
            })
          });

          const data = await resp.json();
          if (!data.success) {
            throw new Error(`Factura ${item.facturaId}: ${data.error || 'Error al guardar'}`);
          }
        }

        // PDF de la última impactada (la de más abajo)
        const ultima = distribucion[0]?.facturaId;
        if (ultima) window.open(`/libros/generar_pdf_credito/${ultima}/`, '_blank');

        setTimeout(() => location.reload(), 1200);

      } catch (err) {
        alert(`⚠️ ${err.message}`);
        console.error(err);
      }
    });
  }
});
</script>

{% endblock %}