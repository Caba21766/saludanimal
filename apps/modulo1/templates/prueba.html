{% extends 'base.html' %}
{% load static %}
{% block navegacion %}
{% include 'navegacion.html' %}
{% endblock %}
{% block contenido %}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">
<!-- Bootstrap CSS (idealmente en base.html, pero lo dejo como lo ten√≠as) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<style>
    /* General */
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f9f9f9;
    }

    .factura-container {
        max-width: 100%;
        width: 800px;
        margin: 20px auto;
        border: 1px solid #000;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Encabezado */
    .factura-container > div {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .factura-container h1 {
        font-size: 24px;
        margin-bottom: 10px;
    }

    .factura-container img {
        max-width: 100px;
        height: auto;
    }

    /* Formulario del cliente */
    form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    form label {
        font-size: 14px;
        margin-bottom: 5px;
        font-weight: bold;
    }

    form input,
    form select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        width: 100%;
    }

    form button {
        padding: 8px 12px;
        font-size: 14px;
        color: #fff;
        background-color: #4caf50;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    form button:hover {
        background-color: #45a049;
    }

    /* Tabla */
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 14px;
        word-wrap: break-word;
        table-layout: fixed;
    }

    .table th,
    .table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .table th {
        background-color: #f4f4f4;
        font-weight: bold;
    }

    tfoot input {
        width: 100%;
        padding: 5px;
        text-align: right;
    }

    /* Botones */
    .btn {
        display: inline-block;
        padding: 8px 12px;
        font-size: 14px;
        color: #fff;
        border: none;
        border-radius: 4px;
        text-align: center;
        cursor: pointer;
    }

    .btn-primary { background-color: #007bff; }
    .btn-primary:hover { background-color: #0056b3; }

    .btn-success { background-color: #28a745; }
    .btn-success:hover { background-color: #218838; }

    .btn-danger { background-color: #dc3545; }
    .btn-danger:hover { background-color: #c82333; }

    tfoot input,
    tfoot select { font-size: 12px; }

    tfoot td, tfoot th { font-size: 13px; }

    @media (max-width: 768px) {
        .table th, .table td { font-size: 10px; padding: 6px; }
        tfoot td, tfoot th { font-size: 10px; }
        tfoot input, tfoot select { font-size: 10px; }

        .table input { font-size: 10px; padding: 3px; text-align: center; }

        .btn { font-size: 12px; padding: 6px 10px; }
        .btn-danger { font-size: 12px; padding: 5px 8px; }

        .btn-aceptar { font-size: 10px; padding: 3px 6px; width: 100%; max-width: 80px; }
    }

    @media (max-width: 480px) {
        .table { font-size: 9px; }
        .table th, .table td { font-size: 9px; padding: 4px; }
        tfoot td, tfoot th { font-size: 9px; }
        tfoot input, tfoot select { font-size: 9px; }

        .table input { font-size: 9px; padding: 2px; }

        .btn { font-size: 10px; padding: 4px 8px; }
        .btn-danger { font-size: 9px; padding: 3px 6px; }

        .btn-aceptar { font-size: 9px; padding: 2px 5px; width: 100%; max-width: 70px; }
    }
</style>

<style>
  /* ‚úÖ Compactar espacios solo en el modal de cr√©dito */
  #creditoModal .modal-body { 
    padding: 12px 16px; 
  }

  #creditoModal .modal-header { 
    padding: 10px 16px; 
  }

  /* reduce separaci√≥n entre bloques */
  #creditoModal .mb-3 { margin-bottom: 8px !important; }
  #creditoModal .mb-2 { margin-bottom: 6px !important; }

  /* labels m√°s pegadas al input */
  #creditoModal .form-label { 
    margin-bottom: 4px; 
    line-height: 1.1; 
  }

  /* inputs un poco m√°s bajos */
  #creditoModal .form-control {
    padding: 6px 10px;
  }

  /* bot√≥n sin tanto aire arriba */
  #creditoModal .text-end { margin-top: 8px; }
</style>


<div class="factura-container">
    <!-- Encabezado de la factura -->
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;
            background-image: url('/static/img/Logos/basketball.png');
            background-repeat: repeat;
            background-size: contain;
            padding: 15px; border-radius: 8px;">
        <div style="line-height: 1.1;">
            <h5 style="margin-bottom: 10px; font-size: 48px; font-family: 'Poppins', sans-serif;">Factura</h5>
            <p style="margin: 0;">Factura N¬∫: {{ numero_factura }}</p>
        </div>
        <div style="line-height: 2;">
            <p style="margin: 0;">Fecha: {{ fecha_actual }}</p>
            <p style="margin: 0;">Hora: {{ hora }}</p>
            <p style="margin: 0;">Vendedor: {{ vendedor }}</p>
        </div>
        <div>
            <img src="{% static 'img/reydelpollo1.png' %}" alt="Logo" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-top: 10px;">
        </div>
    </div>
    <hr>

    <!-- Buscar Clientes -->
    <div style="margin-top: 5px; line-height: 1.2; position: relative;">
        <form id="form_cliente" method="POST">
            {% csrf_token %}
            <input type="text" id="nombre_apellido_cliente" name="nombre_apellido_cliente"
                placeholder="Cliente" autocomplete="off"
                style="width: 200px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
            <input type="hidden" id="dni_cliente_hidden" name="dni_cliente" value="{{ dni_cliente }}">
            <ul id="sugerencias_cliente" class="list-group"
                style="position: absolute; z-index: 999; width: 200px; display: none; background-color: white;
                border: 1px solid #ccc; border-radius: 5px; list-style: none; margin: 0; padding: 0;"></ul>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('nombre_apellido_cliente');
        const hiddenDni = document.getElementById('dni_cliente_hidden');
        const sugerencias = document.getElementById('sugerencias_cliente');
        const form = document.getElementById('form_cliente');

        input.addEventListener('input', function () {
            const texto = this.value.trim();
            if (texto.length < 2) {
                sugerencias.style.display = 'none';
                return;
            }

            fetch(`/modulo1/api/buscar-clientes/?q=${encodeURIComponent(texto)}`)
                .then(res => res.json())
                .then(data => {
                    sugerencias.innerHTML = '';
                    if (data.length === 0) {
                        sugerencias.style.display = 'none';
                        return;
                    }
                    data.forEach(cliente => {
                        const item = document.createElement('li');
                        item.textContent = `${cliente.first_name} ${cliente.last_name} (${cliente.dni_usuario})`;
                        item.style.padding = '6px';
                        item.style.cursor = 'pointer';
                        item.addEventListener('click', () => {
                            input.value = `${cliente.first_name} ${cliente.last_name}`;
                            hiddenDni.value = cliente.dni_usuario;
                            sugerencias.style.display = 'none';
                            form.submit();
                        });
                        sugerencias.appendChild(item);
                    });

                    sugerencias.style.display = 'block';
                });
        });

        document.addEventListener('click', (e) => {
            if (!form.contains(e.target)) {
                sugerencias.style.display = 'none';
            }
        });
    });
    </script>

    <!-- Mostrar mensajes -->
    {% if messages %}
        {% for message in messages %}
            {% if "factura" in message.tags %}
            <div class="alert alert-danger">
                {{ message }}
            </div>
            {% endif %}
        {% endfor %}
    {% endif %}
    <hr>

    <!-- Mostrar datos del cliente -->
    <div style="display: flex; gap: 20px; justify-content: flex-start;">
        <div style="flex: 1; max-width: 200px;">
           <p style="margin: 2px 0; font-size: 12px;"><strong>Nombre:</strong> <span id="nombre_cliente">{{ first_name }}</span></p>
            <p style="margin: 2px 0; font-size: 12px;"><strong>Apellido:</strong> <span id="apellido_cliente">{{ last_name }}</span></p>
        </div>
        <div style="flex: 1; max-width: 200px;">
            <p style="margin: 2px 0; font-size: 12px;"><strong>Cel:</strong> {{ tel1_usuario }}</p>
            <p style="margin: 2px 0; font-size: 12px;"><strong>Dom:</strong> <span id="domicilio_usuario">{{ domicilio_usuario }}</span></p>
        </div>
        <!-- ‚úÖ CORREGIDO HTML roto -->
        <div style="flex: 1; max-width: 200px;">
            <p style="margin: 2px 0; font-size: 12px;">
                <strong>CUIL:</strong> <span id="cuil_usuario">{{ cuil }}</span>
            </p>
            <p style="margin: 2px 0; font-size: 12px;">
                <strong>IVA:</strong> <span id="iva_usuario">{{ iva }}</span>
            </p>
        </div>
    </div>
    <hr>
    <!-- FIN Buscar Clientes -->


    <!-- Buscar producto -->
    <div style="display: flex; margin-top: 10px; background-color: #f2f2f2; padding: 8px; border-radius: 5px;">
        <form id="producto-form" class="flex-wrap mb-3">
            {% csrf_token %}
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                <label for="numero_producto" class="me-2 mb-0" style="font-size: 12px;">N¬∞ Producto:</label>
                <input type="text" id="numero_producto" name="numero_producto" class="form-control form-control-sm"
                       placeholder="N√∫mero Producto" style="width: 100px; font-size: 10px;">
                <button type="button" id="buscar-mercaderia-numero" class="btn btn-success btn-sm me-2" style="font-size: 10px;">Buscar</button>

                <label for="nombre_producto" class="me-2 mb-0" style="font-size: 12px;">Nombre Producto:</label>
                <input type="text" id="nombre_producto" name="nombre_producto" class="form-control form-control-sm"
                       placeholder="Nombre de Producto" autocomplete="off" style="width: 120px; font-size: 10px;">

                <ul id="sugerencias" class="list-group position-absolute"
                    style="z-index: 1000; display: none; width: 180px; max-width: 180px;
                        transform: translateX(200px); background-color: #f8f9fa;
                        border: 1px solid #3f5042; border-radius: 5px; padding: 5px;">
                </ul>

                <button type="button" id="buscar-mercaderia-nombre" class="btn btn-primary btn-sm" style="font-size: 10px;">Buscar</button>
            </div>
        </form>
    </div>

    <hr>
    <style>
        #buscar-mercaderia-nombre { display: none; }
    </style>


    <!-- Tabla factura -->
    <table class="table table-striped">
        <thead style="font-size: 12px;">
            <tr>
                <th style="color: #0b2c4e;">N¬∞ Producto</th>
                <th style="color: #0b2c4e;">Nombre Producto</th>
                <th style="color: #0b2c4e;">Cantidad</th>
                <th style="color: #0b2c4e;">Precio Unitario</th>
                <th style="color: #0b2c4e;">Importe</th>
                <th style="color: #0b2c4e;">Borrar</th>
            </tr>
        </thead>

        <tbody id="producto-info"></tbody>

        <tfoot style="font-size: 12px;">
            <tr>
                <td colspan="4" class="text-end"><strong>Suma:</strong></td>
                <td id="total-general">$0.00</td>
            </tr>

            <tr>
                <td colspan="4" class="text-end"><strong>Desc. (%):</strong></td>
                <td>
                    <input type="number" id="descuento" class="form-control" value="0"
                    min="0" max="100" step="1" autocomplete="off">
                </td>
            </tr>

            <tr>
                <td colspan="4" class="text-end"><strong>Total:</strong></td>
                <td id="total-con-descuento">$0.00</td>
            </tr>

            <tr>
                <td colspan="4" class="text-end"><strong>M√©todo de Pago:</strong></td>
                <td>
                    <!-- ‚úÖ CORREGIDO: ahora el select est√° dentro de seccion-metodos-pago (para que hide/show funcione) -->
                    <div id="seccion-metodos-pago">
                        {% if metodos_pago %}
                            <select id="metodo-pago" name="metodo_pago" class="form-control" style="font-size: 12px;">
                                <option value="Efectivo" style="color: green; font-weight: bold;">Efectivo</option>
                                <option value="Cuenta Corriente" style="color: darkblue; font-weight: bold;">Cuenta Corriente</option>
                                {% for metodo in metodos_pago %}
                                    <option value="{{ metodo.tarjeta_nombre }}">{{ metodo.tarjeta_nombre }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <p style="color:red;">‚ö† No hay m√©todos de pago disponibles.</p>
                        {% endif %}
                    </div>


                    <!-- Modal Cuenta Corriente -->
                    <div class="modal fade" id="creditoModal" tabindex="-1" aria-labelledby="creditoModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content shadow">

                                <div class="modal-header bg-light border-bottom d-flex      flex-column align-items-start">
                                    <small id="metodoPagoSeleccionado" class="text-muted fw-semibold mb-1" style="font-size: 14px;"></small>
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <h5 class="modal-title" id="creditoModalLabel" style="color: #0b2c4e; font-weight: bold;">Registrar Cobro</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                    </div>
                                </div>


                                <div class="modal-body">
                                    <form id="creditoForm" class="needs-validation" novalidate>
                                        <div class="mb-3">
                                            <label for="tarjeta_numero_credito" class="form-label text-danger fw-semibold">N√∫mero Tarjeta:</label>
                                            <input type="text" id="tarjeta_numero_credito" name="tarjeta_numero" class="form-control" maxlength="16" placeholder="Ingrese n√∫mero de tarjeta" required>
                                        </div>

                                        <div class="mb-3">
                                            <label for="numero_ticket_credito" class="form-label text-danger fw-semibold">N√∫mero Ticket:</label>
                                            <input type="text" id="numero_ticket_credito" name="numero_tiket" class="form-control" maxlength="16" placeholder="Ingrese n√∫mero de Ticket" required>
                                        </div>

                                        <input type="hidden" id="modal-factura-id" name="factura_id" value="">

                                        <div class="mb-2">
                                            <label class="form-label fw-semibold">Suma: <span class="text-success" id="suma">$0.00</span></label>
                                        </div>

                                        <div class="mb-3">
                                            <label for="interes" class="form-label text-primary fw-semibold">Ingresar el Inter√©s (%)</label>
                                            <input type="number" id="interes" name="interes" step="0.01" class="form-control" required oninput="calcularInteres()">
                                        </div>

                                        <div class="mb-2">
                                            <label class="form-label">Suma * Int / 100: <span id="interesCalculado" class="text-muted">$0.00</span></label>
                                        </div>

                                        <div class="mb-2">
                                            <label class="form-label">Suma + Inter√©s: <span id="sumaMasInteres" class="text-success">$0.00</span></label>
                                            <input type="hidden" id="totalConInteres" name="total_con_interes">
                                        </div>

                                        <div class="mb-3">
                                            <label for="cuotas" class="form-label text-primary fw-semibold">Cantidad de Cuotas</label>
                                            <input type="number" id="cuotas" name="cuotas" min="1" class="form-control" required oninput="calcularCuotaMensual()">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Cuota Mensual: <span id="cuotaMensual" class="text-success">$0.00</span></label>
                                        </div>

                                        <div class="text-end">
                                            <button type="button" id="guardarCredito" class="btn btn-primary w-100">Guardar Cr√©dito</button>
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Modal Tarjeta -->
                    <div class="modal fade" id="modalTarjeta" tabindex="-1" aria-labelledby="modalTarjetaLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content shadow">
                                <div class="modal-header bg-light">
                                    <h5 class="modal-title" id="modalTarjetaLabel">Cobro con Tarjeta</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                </div>

                                <div class="modal-body">
                                    <form id="formTarjeta">
                                        <div class="mb-3">
                                            <label for="tarjeta_numero_tarjeta" class="form-label text-danger fw-semibold">N√∫mero Tarjeta:</label>
                                            <input type="text" id="tarjeta_numero_tarjeta" name="tarjeta_numero" class="form-control" maxlength="16" placeholder="Ingrese n√∫mero de tarjeta" required>
                                        </div>

                                        <div class="mb-3">
                                            <label for="numero_ticket_tarjeta" class="form-label">N¬∞ Ticket</label>
                                            <input type="text" class="form-control" id="numero_ticket_tarjeta" required>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Seleccion√° una opci√≥n de Cuota</label>
                                            <div id="lista-cuotas" class="list-group" style="max-height: 200px; overflow-y: auto;"></div>

                                            <input type="hidden" id="cuotas_tarjeta">
                                            <input type="hidden" id="interes_tarjeta">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Cuota Mensual</label>
                                            <input type="text" id="cuota_mensual" class="form-control" readonly>
                                        </div>

                                        <div class="text-end">
                                            <button type="button" id="guardarTarjeta" class="btn btn-primary w-100">Guardar Tarjeta</button>
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>

                </td>
            </tr>

            <tr>
                <td colspan="4"></td>
                <td style="text-align: center; padding-top: 10px;">
                    <!-- dejo tu onclick como estaba para no romper nada -->
                    <button type="button" id="guardar" class="btn btn-primary btn-sm me-1" style="font-size: 9px;">
                        Aceptar1
                    </button>
                </td>
            </tr>
        </tfoot>
    </table>
    <!-- Fin de Tabla factura -->




    <!-- C√°lculos modal cr√©dito -->
    <script>
        function actualizarSuma() {
            let totalConDescuentoElemento = document.getElementById("total-con-descuento");
            if (!totalConDescuentoElemento) return;

            let totalConDescuentoTexto = totalConDescuentoElemento.textContent.replace('$', '').trim();
            let totalConDescuento = parseFloat(totalConDescuentoTexto) || 0;

            let sumaElemento = document.getElementById("suma");
            if (!sumaElemento) return;

            sumaElemento.textContent = totalConDescuento.toFixed(2);
            calcularInteres();
        }

        function calcularInteres() {
            let suma = parseFloat(document.getElementById("suma").textContent) || 0;
            let interes = parseFloat(document.getElementById("interes").value) || 0;

            let interesCalculado = (suma * interes) / 100;
            document.getElementById("interesCalculado").textContent = interesCalculado.toFixed(2);

            calcularSumaMasInteres(suma, interesCalculado);
        }

        function calcularSumaMasInteres(suma, interesCalculado) {
            let sumaMasInteres = suma + interesCalculado;
            document.getElementById("sumaMasInteres").textContent = sumaMasInteres.toFixed(2);
            document.getElementById("totalConInteres").value = sumaMasInteres.toFixed(2);
        }

        function calcularCuotaMensual() {
            let sumaMasInteres = parseFloat(document.getElementById("sumaMasInteres").textContent) || 0;
            let cuotas = parseInt(document.getElementById("cuotas").value) || 1;

            let cuotaMensual = sumaMasInteres / cuotas;
            document.getElementById("cuotaMensual").textContent = cuotaMensual.toFixed(2);
        }

        document.addEventListener("DOMContentLoaded", function () {
            // ‚úÖ funci√≥n para resetear descuento a 0 (reutilizable)
            function resetDescuento() {
                const d = document.getElementById("descuento");
                if (!d) return;
                d.value = "0";
                d.defaultValue = "0";

                if (typeof calcularTotalGeneral === "function") calcularTotalGeneral();
                if (typeof actualizarSuma === "function") actualizarSuma();
            }

                // ‚úÖ 1) Descuento siempre empieza en 0
            const descuentoInput = document.getElementById("descuento");
            if (descuentoInput) {
                resetDescuento();

                // ‚úÖ evita que se cambie solo con la ruedita del mouse
                descuentoInput.addEventListener("wheel", function (e) {
                    e.preventDefault();
                }, { passive: false });

                // ‚úÖ cuando cambia el descuento recalcular totales y suma del modal
                descuentoInput.addEventListener("input", function () {
                    if (typeof calcularTotalGeneral === "function") {
                        calcularTotalGeneral();
                    }
                    if (typeof actualizarSuma === "function") {
                        actualizarSuma();
                    }
                });
            }

            // ‚úÖ 2) Cuando eleg√≠s un cliente (click en sugerencia) ‚Üí descuento vuelve a 0 antes de submit
            const sugerenciasCliente = document.getElementById("sugerencias_cliente");
            if (sugerenciasCliente) {
                sugerenciasCliente.addEventListener("click", function (e) {
                    const li = e.target.closest("li");
                    if (!li) return;

                    // esperamos un "tick" para que tu c√≥digo asigne el DNI y el input
                    setTimeout(() => {
                        resetDescuento();
                    }, 0);
                });
            }

        });

        // ‚úÖ 2) Cuando abre el modal de cr√©dito recalcula suma
        const creditoModal = document.getElementById("creditoModal");
        if (creditoModal) {
            creditoModal.addEventListener("show.bs.modal", function () {
                actualizarSuma();
            });
        }

        // ‚úÖ 3) Si cambian cuotas recalcular cuota mensual
        const cuotasInput = document.getElementById("cuotas");
        if (cuotasInput) {
            cuotasInput.addEventListener("input", function () {
                calcularCuotaMensual();
            });
        }

        // ‚úÖ 4) Inicial: recalcular todo al cargar
        if (typeof calcularTotalGeneral === "function") {
            calcularTotalGeneral();
        }
        actualizarSuma();
    </script>
    <!-- Fin C√°lculos modal cr√©dito -->



    <!-- Productos + totales -->
    <script>
    function agregarProductoATabla(data) {
        if (data.error) {
            alert(data.error);
        } else {
            const tableBody = document.getElementById('producto-info');
            const newRow = document.createElement('tr');

            const cellNumero = document.createElement('td');
            const cellNombre = document.createElement('td');
            const cellCantidadVendida = document.createElement('td');
            const cellPrecioUnitario = document.createElement('td');
            const cellSubtotal = document.createElement('td');
            const cellEliminar = document.createElement('td');

            cellNumero.textContent = data.numero_producto ? data.numero_producto : 'N/A';
            cellNombre.textContent = data.nombre_producto ? data.nombre_producto : 'N/A';

            const precioUnitario = parseFloat(data.precio) || 0;

            const inputPrecioUnitario = document.createElement('input');
            inputPrecioUnitario.type = 'number';
            inputPrecioUnitario.value = precioUnitario.toFixed(2);
            inputPrecioUnitario.min = 0;
            inputPrecioUnitario.className = 'form-control';
            inputPrecioUnitario.disabled = true;
            cellPrecioUnitario.appendChild(inputPrecioUnitario);

            const inputCantidadVendida = document.createElement('input');
            inputCantidadVendida.type = 'number';
            inputCantidadVendida.value = 1;
            inputCantidadVendida.min = 0.01;
            inputCantidadVendida.step = 0.01;
            inputCantidadVendida.className = 'form-control';
            inputCantidadVendida.addEventListener('input', function () {
                const subtotal = parseFloat(inputCantidadVendida.value) * parseFloat(inputPrecioUnitario.value || 0);
                inputSubtotal.value = subtotal.toFixed(2);
                calcularTotalGeneral();
            });
            cellCantidadVendida.appendChild(inputCantidadVendida);

            const inputSubtotal = document.createElement('input');
            inputSubtotal.type = 'number';
            inputSubtotal.value = (precioUnitario * parseFloat(inputCantidadVendida.value)).toFixed(2);
            inputSubtotal.min = 0;
            inputSubtotal.step = 0.01;
            inputSubtotal.className = 'form-control';
            inputSubtotal.addEventListener('input', function () {
                const nuevoSubtotal = parseFloat(inputSubtotal.value) || 0;
                const nuevaCantidad = nuevoSubtotal > 0 ? (nuevoSubtotal / precioUnitario).toFixed(2) : 0;
                inputCantidadVendida.value = nuevaCantidad;
                calcularTotalGeneral();
            });
            cellSubtotal.appendChild(inputSubtotal);

            const btnEliminar = document.createElement('button');
            btnEliminar.className = 'btn btn-danger btn-sm';
            btnEliminar.textContent = 'Eliminar';
            btnEliminar.addEventListener('click', function () {
                newRow.remove();
                calcularTotalGeneral();
            });
            cellEliminar.appendChild(btnEliminar);

            newRow.appendChild(cellNumero);
            newRow.appendChild(cellNombre);
            newRow.appendChild(cellCantidadVendida);
            newRow.appendChild(cellPrecioUnitario);
            newRow.appendChild(cellSubtotal);
            newRow.appendChild(cellEliminar);

            tableBody.appendChild(newRow);
            calcularTotalGeneral();
        }
    }

    document.getElementById('buscar-mercaderia-numero').addEventListener('click', function () {
        const numeroProducto = document.getElementById('numero_producto').value;

        fetch(`/modulo1/buscar-mercaderia/?numero_producto=${numeroProducto}`)
            .then(response => {
                if (!response.ok) throw new Error('Error al buscar la mercader√≠a');
                return response.json();
            })
            .then(data => agregarProductoATabla(data))
            .catch(error => {
                console.error(error);
                alert('Ocurri√≥ un error al buscar la mercader√≠a por n√∫mero.');
            });
    });

    document.getElementById('buscar-mercaderia-nombre').addEventListener('click', function () {
        const nombreProducto = document.getElementById('nombre_producto').value;

        fetch(`/modulo1/buscar-mercaderia/?nombre_producto=${encodeURIComponent(nombreProducto)}`)
            .then(response => {
                if (!response.ok) throw new Error('Error al buscar la mercader√≠a');
                return response.json();
            })
            .then(data => agregarProductoATabla(data))
            .catch(error => {
                console.error(error);
                alert('Ocurri√≥ un error al buscar la mercader√≠a por nombre.');
            });
    });

    function calcularTotalGeneral() {
        const rows = document.querySelectorAll('#producto-info tr');
        let totalGeneral = 0;

        rows.forEach(row => {
            const importeInput = row.cells[4].querySelector('input');
            if (importeInput) {
                totalGeneral += parseFloat(importeInput.value || 0);
            }
        });

        document.getElementById('total-general').textContent = `$${totalGeneral.toFixed(2)}`;
        const descuentoPorcentaje = parseFloat(document.getElementById('descuento').value) || 0;
        const totalConDescuento = totalGeneral - (totalGeneral * (descuentoPorcentaje / 100));
        document.getElementById('total-con-descuento').textContent = `$${totalConDescuento.toFixed(2)}`;
    }
    </script>
    <!-- Fin Productos + totales -->

    <!-- Autocomplete nombre producto -->
    <script>
        document.getElementById('nombre_producto').addEventListener('input', function () {
        const query = this.value;
        const sugerencias = document.getElementById('sugerencias');

        if (query.trim()) {
            fetch(`/modulo1/buscar-mercaderia/?nombre_producto=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    sugerencias.innerHTML = '';
                    sugerencias.style.display = 'block';

                    if (data.length === 0) {
                        sugerencias.style.display = 'none';
                    } else {
                        data.forEach(producto => {
                            const item = document.createElement('li');
                            item.className = 'list-group-item list-group-item-action';
                            item.textContent = producto.nombre_producto;

                            item.setAttribute('data-numero-producto', producto.numero_producto);
                            item.setAttribute('data-precio', producto.precio);

                            item.addEventListener('click', function () {
                                document.getElementById('nombre_producto').value = producto.nombre_producto;
                                document.getElementById('numero_producto').value = producto.numero_producto;

                                agregarProductoATabla({
                                    numero_producto: producto.numero_producto,
                                    nombre_producto: producto.nombre_producto,
                                    precio: producto.precio,
                                });

                                sugerencias.style.display = 'none';
                            });

                            sugerencias.appendChild(item);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al buscar sugerencias:', error);
                    sugerencias.style.display = 'none';
                });
        } else {
            sugerencias.style.display = 'none';
        }
        });
    </script>
    <!-- Fin Autocomplete nombre producto Termina -->
  



    <!-- ‚úÖ Flujo principal de m√©todo de pago + guardado -->
    <script>
        // ‚úÖ Solo una vez (evita duplicaciones si el template se reinyecta)
        if (!window.__FACTURA_BINDINGS__) {
            window.__FACTURA_BINDINGS__ = true;

        // ‚úÖ Guardar cr√©dito (solo si existe el bot√≥n)
        const btnGuardarCredito = document.getElementById('guardarCredito');
        if (btnGuardarCredito) {
            btnGuardarCredito.addEventListener('click', function () {
                let modalElement = document.getElementById('creditoModal');
                if (modalElement) modalElement.dataset.confirmado = "true";
                guardarFactura("guardarCredito");
            });
        }

        // ‚úÖ Guardar tarjeta (solo si existe el bot√≥n)
        const btnGuardarTarjeta = document.getElementById('guardarTarjeta');
        if (btnGuardarTarjeta) {
            btnGuardarTarjeta.addEventListener('click', function () {
                const tarjetaNumeroInput = document.getElementById('tarjeta_numero_tarjeta');
                const ticketInput = document.getElementById('numero_ticket_tarjeta');
                const cuotasInput = document.getElementById('cuotas_tarjeta');
                const interesInput = document.getElementById('interes_tarjeta');

                const tarjetaNumero = tarjetaNumeroInput?.value.trim() || '';
                const ticketNumero = ticketInput?.value.trim() || '';
                const cuotasStr = cuotasInput?.value.trim() || '';
                const interesStr = interesInput?.value.trim() || '';

                if (!tarjetaNumero || !ticketNumero || !cuotasStr || !interesStr) {
                    alert("‚ö† Por favor, complet√° todos los campos y seleccion√° una cuota v√°lida.");
                    return;
                }

                const cuotas = parseInt(cuotasStr);
                const interes = parseFloat(interesStr);

                if (isNaN(cuotas) || isNaN(interes) || cuotas <= 0 || interes < 0) {
                    alert("‚ö† Los datos de la cuota son inv√°lidos. Por favor, volv√© a seleccionar.");
                    return;
                }

                const totalBase = parseFloat(document.getElementById('total-con-descuento')?.textContent.replace('$', '').trim()) || 0;
                const totalConInteres = totalBase + (totalBase * (interes / 100));
                const cuotaMensual = (totalConInteres / cuotas).toFixed(2);

                const cuotaMensualInput = document.getElementById('cuota_mensual');
                if (cuotaMensualInput) cuotaMensualInput.value = `$${cuotaMensual}`;

                guardarFactura("guardarTarjeta");
            });
        }

        // ‚úÖ M√©todo de pago (solo si existe el select)
        const selectMetodoPago = document.getElementById('metodo-pago');
        if (selectMetodoPago) {
            selectMetodoPago.addEventListener('change', function () {
                const metodoPago = this.value;

                if (metodoPago === "Efectivo") {
                    guardarFactura("guardar");
                    return;
                }

                if (metodoPago === "Cuenta Corriente") {
                    const modalCreditoEl = document.getElementById('creditoModal');
                    if (modalCreditoEl) new bootstrap.Modal(modalCreditoEl).show();
                    return;
                }

                const modalLabel = document.getElementById('modalTarjetaLabel');
                if (modalLabel) modalLabel.textContent = `Cobro con: ${metodoPago}`;

                const modalTarjetaEl = document.getElementById('modalTarjeta');
                if (modalTarjetaEl) {
                    const modalTarjeta = new bootstrap.Modal(modalTarjetaEl);
                    modalTarjeta.show();
                }

                fetch(`/modulo1/api/cuotas/${encodeURIComponent(metodoPago)}/`)
                    .then(res => res.json())
                    .then(data => {
                        const lista = document.getElementById('lista-cuotas');
                        if (!lista) return;

                        lista.innerHTML = '';

                        if (!Array.isArray(data) || data.length === 0) {
                            lista.innerHTML = '<div class="text-danger">‚ö† No hay cuotas disponibles para esta tarjeta.</div>';
                            return;
                        }

                        data.forEach(item => {
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'list-group-item list-group-item-action';
                            btn.textContent = `${item.cuotas} cuota(s) - ${item.interes}% inter√©s`;

                            btn.addEventListener('click', () => {
                                const cuotasTarjeta = document.getElementById('cuotas_tarjeta');
                                const interesTarjeta = document.getElementById('interes_tarjeta');
                                if (cuotasTarjeta) cuotasTarjeta.value = item.cuotas;
                                if (interesTarjeta) interesTarjeta.value = item.interes;

                                const total = parseFloat(document.getElementById('total-con-descuento')?.textContent.replace('$', '')) || 0;
                                const totalConInteres = total + (total * (item.interes / 100));
                                const cuotaMensual = totalConInteres / item.cuotas;

                                const cuotaMensualInput = document.getElementById('cuota_mensual');
                                if (cuotaMensualInput) cuotaMensualInput.value = `$${cuotaMensual.toFixed(2)}`;

                                document.querySelectorAll('#lista-cuotas .list-group-item').forEach(el => el.classList.remove('active'));
                                btn.classList.add('active');
                            });

                            lista.appendChild(btn);
                        });
                    })
                    .catch(err => {
                        console.error("Error al cargar cuotas:", err);
                        const lista = document.getElementById('lista-cuotas');
                        if (lista) lista.innerHTML = '<div class="text-danger">Error al obtener cuotas.</div>';
                    });
            });
        }

        // ‚úÖ Bot√≥n aceptar ‚Üí guarda (solo si existe)
        const btnAceptar = document.getElementById('guardar');
        if (btnAceptar) {
            btnAceptar.addEventListener('click', function () {
                guardarFactura("guardar");
            });
        }
        }

        // ‚úÖ ------------ guardar Factura (correcciones m√≠nimas) ----------------------------
        function guardarFactura(origen) {
        console.log(`üìå Guardando desde: ${origen}`);

        const guardarBtn = document.getElementById('guardar');
        if (guardarBtn) {
            guardarBtn.disabled = true;
            guardarBtn.textContent = "Guardando...";
        }

        const fecha = new Date().toISOString().split('T')[0];

        const dniCliente = document.getElementById('dni_cliente_hidden')?.value.trim() || '';

        // ‚úÖ M√ÅS ROBUSTO: tomamos de spans con ID (ten√©s que agregarlos en el HTML)
        const nombreCliente = document.getElementById('nombre_cliente')?.textContent.trim() || '';
        const apellidoCliente = document.getElementById('apellido_cliente')?.textContent.trim() || '';

        const domicilioFactura = document.getElementById("domicilio_usuario")?.textContent?.trim() || '';
        const cuilFactura = document.getElementById("cuil_usuario")?.textContent?.trim() || '';
        const ivaFactura = document.getElementById("iva_usuario")?.textContent?.trim() || '';
        const metodoPago = document.getElementById('metodo-pago')?.value.trim() || '';

        const total = parseFloat(document.getElementById('total-general')?.textContent.replace('$', '').trim()) || 0;
        const descuento = parseFloat(document.getElementById('descuento')?.value.trim()) || 0;
        const totalConDescuento = total - (total * (descuento / 100));

        let tarjetaNombre = '';
        let tarjetaNumero = '';
        let numeroTicket = '';
        let interes = 0;
        let cuotas = 1;
        let totalConInteres = totalConDescuento;

        const creditoModal = document.getElementById("creditoModal");
        const tarjetaModal = document.getElementById("modalTarjeta");

        if (origen === "guardarCredito" || (creditoModal && creditoModal.classList.contains("show"))) {
            tarjetaNumero = document.getElementById('tarjeta_numero_credito')?.value.trim() || '';
            tarjetaNombre = metodoPago;
            numeroTicket = document.getElementById('numero_ticket_credito')?.value.trim() || '';

            interes = parseFloat(document.getElementById('interes')?.value.trim() || 0);
            cuotas = parseInt(document.getElementById('cuotas')?.value.trim() || 1);
            totalConInteres = parseFloat(document.getElementById('totalConInteres')?.value.trim() || totalConDescuento);
        }

        if (origen === "guardarTarjeta" || (tarjetaModal && tarjetaModal.classList.contains("show"))) {
            tarjetaNumero = document.getElementById('tarjeta_numero_tarjeta')?.value.trim() || '';
            tarjetaNombre = metodoPago;
            numeroTicket = document.getElementById('numero_ticket_tarjeta')?.value.trim() || '';
            cuotas = parseInt(document.getElementById('cuotas_tarjeta')?.value.trim() || 1);
            interes = parseFloat(document.getElementById('interes_tarjeta')?.value.trim() || 0);

            const totalBase = parseFloat(document.getElementById('total-con-descuento')?.textContent.replace('$', '')) || 0;
            totalConInteres = totalBase + (totalBase * (interes / 100));
        }

        const cuotaMensual = cuotas > 0 ? (totalConInteres / cuotas).toFixed(2) : "0";

        const detalleProductos = [];
        document.querySelectorAll('#producto-info tr').forEach(row => {
            const numeroProducto = row.cells[0]?.textContent || '';
            const nombreProducto = row.cells[1]?.textContent || '';
            const cantidadVendida = parseFloat(row.cells[2]?.querySelector('input')?.value || 0);
            const precioUnitario = parseFloat(row.cells[3]?.querySelector('input')?.value || 0);
            const subtotal = parseFloat(row.cells[4]?.querySelector('input')?.value || 0);

            if (numeroProducto && nombreProducto && cantidadVendida && precioUnitario && subtotal) {
                detalleProductos.push({
                    numero_producto: numeroProducto,
                    nombre_producto: nombreProducto,
                    cantidad_vendida: cantidadVendida,
                    precio_unitario: precioUnitario,
                    subtotal: subtotal,
                });
            }
        });

        const payload = {
            fecha: fecha,
            dni_cliente: dniCliente,
            nombre_cliente: nombreCliente,
            apellido_cliente: apellidoCliente,
            domicilio_factura: domicilioFactura,
            cuil: cuilFactura,
            iva: ivaFactura,
            metodo_pago: metodoPago,
            tarjeta_nombre: tarjetaNombre,
            tarjeta_numero: tarjetaNumero,
            numero_tiket: numeroTicket,
            total: total,
            descuento: descuento,
            total_con_descuento: totalConDescuento,
            interes: interes,
            cuotas: cuotas,
            cuota_mensual: cuotaMensual,
            total_con_interes: totalConInteres,
            detalle_productos: detalleProductos,
        };

        fetch('/modulo1/guardar-prueba/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
            },
            body: JSON.stringify(payload),
        })
        .then(response => response.json())
        .then(data => {
            if (data.redirect) {
                window.location.href = data.redirect;
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error("‚ùå Error en la petici√≥n:", error);
            alert("Ocurri√≥ un error al guardar la factura.");
        })
        .finally(() => {
            if (guardarBtn) {
                guardarBtn.disabled = false;
                guardarBtn.textContent = "Aceptar";
            }
        });
        }
    </script>
</div>
{% endblock %}